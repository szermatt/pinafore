<script>
  import {
      acceptShortcutEvent,
      addToShortcutScope,
      removeFromShortcutScope } from '../../_utils/shortcuts'
  export default {
      data: () => ({scope: null, key: null, modal: false, currentPrefixMap: null}),
      oncreate() {
	  let {scope} = this.get()
	  if (scope) {
              addToShortcutScope(scope, this)
          } else if (!this.listener) {
	      this.listener = this.onKeyDown.bind(this)
	      window.addEventListener("keydown", this.listener);
	  }
      },
      ondestroy() {
          let {scope} = this.get()
	  if (scope) {
              removeFromShortcutScope(scope, this)
          }
          if (this.listener) {
  	      window.removeEventListener("keydown", this.listener);
          }
      },
      computed: {
          keyMap: ({key}) => {
              let keyMap = new Map()
              if (key) {
                  key.split('|').forEach(
                      (seq) => {
                          let seqArray = seq.split(' ')
                          let prefixLen = seqArray.length - 1
                          let currentMap = keyMap;
                          let i = -1
                          while (++i < prefixLen) {
                              let prefixMap = currentMap[seqArray[i]]
                              if (!prefixMap) {
                                  prefixMap = new Map()
                                  currentMap[seqArray[i]] = prefixMap
                              }
                              currentMap = prefixMap
                          }
                          currentMap[seqArray[seqArray.length - 1]] = true
                      })
              }
              return keyMap
          }
      },
      methods: {
	  onKeyDown(event) {
	      let { keyMap, currentPrefixMap, modal } = this.get()
              if (!acceptShortcutEvent(event, modal)) {
                  return
              }
              let mapValue = ((currentPrefixMap && currentPrefixMap[event.key])
                              || keyMap[event.key])
              if (!mapValue) {
                  return
              }
	      event.stopPropagation()
              if (mapValue == true) {
	          this.fire('pressed', {
		      key: event.key,
		      timeStamp: event.timeStamp})
              } else {
                  currentPrefixMap = mapValue
                  this.set({currentPrefixMap})
              }
	  }
      }
  };
</script>
