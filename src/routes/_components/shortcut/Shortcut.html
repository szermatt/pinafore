<svelte:target ref:target/>
<script>
  import {
      acceptShortcutEvent,
      addToShortcutScope,
      removeFromShortcutScope } from '../../_utils/shortcuts'
  export default {
      data: () => ({scope: null, key: null, modal: false}),
      oncreate() {
	  let {scope} = this.get()
	  if (scope) {
              addToShortcutScope(scope, this)
          } else if (!this.listener) {
	      console.log('add listener')
	      this.listener = this.onKeyDown.bind(this)
	      window.addEventListener("keydown", this.listener);
	  }
      },
      ondestroy() {
          let {scope} = this.get()
	  if (scope) {
              removeFromShortcutScope(scope, this)
          }
          if (this.listener) {
  	      window.removeEventListener("keydown", this.listener);
          }
      },
      computed: {
          keySet: ({key}) => {
              let keySet = new Set()
              if (key) {
                  key.split('|').forEach((key) => keySet.add(key))
              }
              return keySet
          }
      },
      methods: {
	  onKeyDown(event) {
	      let { keySet, modal } = this.get()
	      if (!keySet.has(event.key)) {
                  return
              }
              if (!acceptShortcutEvent(event, modal)) {
                  return
              }
	      event.stopPropagation()
	      this.fire('pressed', {
		  key: event.key,
		  timeStamp: event.timeStamp})
	  }
      }
  };
</script>
